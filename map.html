<!DOCTYPE html>
<html lang="en">

<!-- caveat emptor: first versions of this created with Claude.AI. For fun only :)  -->

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vintage style map with custom markers using MapTiler & OpenHistoricalMaps</title>
  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/@openhistoricalmap/maplibre-gl-dates/index.js"></script>
  <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />


  <link href="https://unpkg.com/@watergis/maplibre-gl-export@3.8.0/dist/maplibre-gl-export.css" rel="stylesheet">

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Garamond;
    }

    #map {
      width: 100%;
      height: 100vh;
    }

    .info-panel {
      position: absolute;
      top: 10px;
      left: 50px;
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      max-width: 300px;
    }

    .info-panel h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
    }

    .info-panel p {
      margin: 5px 0;
      font-size: 14px;
    }

    .maplibregl-popup-content {
      padding: 10px;
      font-family: Garamond !important;
    }

    .maplibregl-popup-content h4 {
      margin: 0 0 5px 0;
    }

    .maplibregl-marker {
      z-index: 1000 !important;
    }

    #buttons {
      position: absolute;
      top: 10px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: row;
    }

    #export-btn,
    #import-btn {
      padding: 10px 20px;
      background: white;
      border: 2px solid #333;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    #export-btn:hover,
    #import-btn:hover {
      background: #f0f0f0;
    }

    #export-btn:active,
    #import-btn:active {
      background: #e0e0e0;
    }

    #import-container {
      position: absolute;
      top: 10px;
      right: 150px;
      width: 30rem;
      z-index: 1000;
      background: white;
      border: 2px solid #333;
      border-radius: 4px;
      padding: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    #json-input {
      width: 300px;
      width: 95%;
      height: 100px;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      resize: vertical;
    }

    #import-btn-go {
      margin-top: 5px;
      padding: 8px 16px;
      background: #333;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      width: 100%;
    }

    #import-btn-go:hover {
      background: #555;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div id="mapui">
    <div class="info-panel">
      <h3>Instructions</h3>
      <p>Set POI to change the locations displayed, or edit the <code>pointsOfInterest</code> array in the code.</p>
      <p>Export Map will save the map image to a file.</p>
      <p>The compass rose can be moved by clicking and dragging it</p>
      <!-- <p><strong>Format:</strong> [latitude, longitude, "Name", "Description"]</p> -->
      <!-- <p><em>Note: longitude comes first!</em></p> -->
    </div>
    <div id="buttons">
      <button id="import-btn">Set POI</button>
      <button id="export-btn">Export Map</button>
    </div>

    <div id="import-container" style="display: none;">
      <textarea id="json-input"
        placeholder='Paste list of entries here, e.g.
      [48.8566,2.3522,"Paris", "The City of Light"],
      [51.5074,-0.1278,"London", "Old Londinium"]
      
      format is 
      [Latitude, Longitude, Name, Description]
      '></textarea>
      <button id="import-btn-go">Set POI JSON</button>
    </div>
  </div>

  <script>
    let mapcanvas = null;

    // ==============================================
    // EDIT YOUR POINTS OF INTEREST HERE
    // IMPORTANT: Format is [LONGITUDE, LATITUDE, name, description]
    // Longitude comes FIRST (this is different from Leaflet!)
    // ACTUALLY NO. IT IS LAT/LON, I REVERSED IT BECAUSE TOO MUCH CONFUSION. 
    // I RE-REVERSE THEM WHEN I CALL MAPLIBRE FUNCTIONS
    // ==============================================
    let pointsOfInterest = [
      [38.1938, 15.5540, "Messina, Sicily", "Messina, Sicily, the location where Richard embarked to sail to the Holy Land."],
      [34.6731, 33.0449, "Limassol"],
      [35.3086, 33.2811, "Saint Hilarion Castle, Cyprus"],
      [31.7683, 35.2137, "Jerusalem", "Jerusalem"],
      [34.7759, 35.9982, "Margat Castle, Syria"],
      [32.9236, 35.0710, "Acre"],
      [32.1066, 34.7781, "Arsuf & Jaffa"],
    ];
    const rome = [12.49637, 41.90278];

    // geojson for compass rose display. default to rome, will be recentered later.
    const compassGeojson = {
      'type': 'FeatureCollection',
      'features': [
        {
          'type': 'Feature',
          'geometry': {
            'type': 'Point',
            'coordinates': [rome[0], rome[1]]
          }
        }
      ]
    };

    // ==============================================
    // EVENT HANDLERS
    // ==============================================

    // My export 
    document.getElementById('export-btn').addEventListener('click', () => {
      exportMapToHighRes(map);
    });

    document.getElementById('import-btn').addEventListener('click', () => {
      const panel = document.getElementById('import-container');
      panel.style.display = 'block';
    });

    // Handle JSON import
    document.getElementById('import-btn-go').addEventListener('click', () => {
      const jsonText = document.getElementById('json-input').value;

      if (!jsonText.trim()) {
        alert('Please paste JSON first');
        return;
      }

      try {
        let object = `[ ${jsonText} ]`;
        pointsOfInterest = JSON.parse(object);

        display();
        // hide json panel
        document.getElementById('import-container').style.display = 'none';
        console.log('Points of Interest loaded:', pointsOfInterest);
        alert('POI JSON loaded successfully!');
      } catch (error) {
        console.error('Error parsing JSON:', error);
        alert('Error: Invalid JSON format');
      }
    });

    // ==============================================
    // MAP CONFIGURATION
    // ==============================================

    // Initialize the map with OpenHistoricalMap style
    // nope use our own.
    // style: 'https://unpkg.com/@openhistoricalmap/map-styles@latest/dist/woodblock/woodblock.json',
    const map = new maplibregl.Map({
      container: 'map',
      style: 'https://viking2917.github.io/bookmap/bookmap.json',
      // use this style to see historical kingdom names and boundaries.
      // style: 'https://viking2917.github.io/bookmap/bookmap_openhistoricalmap.json',
      center: [rome[0], rome[1]], // Default center [lng, lat]
      zoom: 4,
      preserveDrawingBuffer: true
    });

    mapcanvas = map.getCanvasContainer();

    map.on('load', function () {

      addCompass();
      // Add navigation controls (zoom buttons)
      map.addControl(new maplibregl.NavigationControl({ showZoom: true }), 'top-left');
      // Add scale control
      map.addControl(new maplibregl.ScaleControl({
        maxWidth: 200,
        unit: 'imperial'
      }), 'bottom-left');

      // ==============================================
      // OPTIONAL: DATE FILTERING
      // ==============================================
      // This is useful for viewing historical data from a specific time period
      map.on('styledata', function () {
        // Set the year you want to display (example: 1900)
        const targetYear = 1187;
        const targetDate = `${targetYear}-01-01`;

        // Apply date filter if the function exists
        if (map.filterByDate) {
          console.log('data filtering map');
          map.filterByDate(targetDate);
        }
      });

      display();
      setupExportPlugin();
    });

    async function display() {
      // remove if exists
      removeGeoJSONSource(map, 'poi-source');

      // Create GeoJSON from points
      let poiGeojson = loadPOI();

      // ADD MARKERS AFTER MAP LOADS
      // ─────────────────────────────────────
      // 1️⃣ Add point source
      // ─────────────────────────────────────

      // Add source
      map.addSource('poi-source', {
        type: 'geojson',
        data: poiGeojson
      });

      // ─────────────────────────────────────
      // 2️⃣ Outer engraved ring(s)
      // ─────────────────────────────────────
      map.addLayer({
        id: "marker-ring-2",
        type: "circle",
        source: "poi-source",
        paint: {
          "circle-radius": [
            "interpolate",
            ["linear"],
            ["zoom"],
            4, 6,
            10, 10
          ],
          "circle-color": "rgba(0,0,0,0)",
          "circle-stroke-width": 1,
          "circle-stroke-color": "rgba(255,255,255,0.5)",
          "circle-stroke-opacity": 0.9
        }
      });

      map.addLayer({
        id: "marker-ring",
        type: "circle",
        source: "poi-source",
        paint: {
          "circle-radius": [
            "interpolate",
            ["linear"],
            ["zoom"],
            4, 4,
            10, 8
          ],
          "circle-color": "rgba(0,0,0,0)",
          "circle-stroke-width": 2,
          "circle-stroke-color": "#696969",
          "circle-stroke-opacity": 0.9
        }
      });

      // ─────────────────────────────────────
      // 3️⃣ Inner ink dot
      // ─────────────────────────────────────
      map.addLayer({
        id: "marker-core",
        type: "circle",
        source: "poi-source",
        paint: {
          "circle-radius": [
            "interpolate",
            ["linear"],
            ["zoom"],
            4, 3,
            10, 6
          ],
          "circle-color": "#696969",
          "circle-opacity": 0.95
        }
      });

      // ─────────────────────────────────────
      // 4️⃣ City labels (engraved atlas style)
      // ─────────────────────────────────────
      map.addLayer({
        id: "marker-labels",
        type: "symbol",
        source: "poi-source",
        layout: {
          "text-field": ["get", "name"],
          "text-font": ["Noto Serif Bold"],
          "text-size": [
            "interpolate",
            ["linear"],
            ["zoom"],
            0, 8,
            3, 12,
            6, 14,
            10, 18
          ],
          'text-max-width': 20,
          "text-offset": [0.65, 0],
          "text-variable-anchor": ["left", "right"],
          "text-allow-overlap": true,
          "symbol-placement": "point"
        },
        paint: {
          "text-color": "#222",

          "text-halo-width": 1.5,

          // "text-halo-color": "#ff0000",          
          "text-halo-color": [
            "interpolate",
            ["linear"],
            ["zoom"],
            0, "rgba(240, 244, 216, 1)",
            10, "rgba(246,247,227, 1)"
          ],
        }
      });


      // Add click handler for popups
      map.on('click', 'marker-labels', (e) => {
        const coordinates = e.features[0].geometry.coordinates.slice();
        const { name, description } = e.features[0].properties;

        let popupHTML = `<h4>${name}</h4>`;
        if (description) popupHTML += `<p>${description}</p>`;

        new maplibregl.Popup()
          .setLngLat(coordinates)
          .setHTML(popupHTML)
          .addTo(map);
      });

      map.on('mouseenter', 'marker-labels', () => {
        map.getCanvas().style.cursor = 'pointer';
      });

      map.on('mouseleave', 'marker-labels', () => {
        map.getCanvas().style.cursor = '';
      });

      // Fit bounds
      const bounds = new maplibregl.LngLatBounds();
      pointsOfInterest.forEach(poi => bounds.extend([poi[1], poi[0]]));
      if (pointsOfInterest.length > 0) {
        map.fitBounds(bounds, { padding: 200, maxZoom: 15 });
      }

      // recenter compass rose
      compassGeojson.features[0].geometry.coordinates = [bounds.getCenter().lng, bounds.getSouth()];
      map.getSource('compasspoint').setData(compassGeojson);
    }

    function loadPOI() {
      return {
        type: 'FeatureCollection',
        features: pointsOfInterest.map(poi => ({
          type: 'Feature',
          geometry: {
            type: 'Point',
            // lat/lon reversed in this map library...
            coordinates: [poi[1], poi[0]]
          },
          properties: {
            name: poi[2],
            description: poi[3]
          }
        }))
      };
    }

    // compass display
    function addCompass() {
      const existingImages = {};
      map.on('styleimagemissing', async (e) => {
        if (existingImages[e.id]) {
          return;
        }
        existingImages[e.id] = true;
        const response = await fetch(e.id);
        const svgText = await response.text();
        const svg = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgText);
        const image = new Image();
        const promise = new Promise((resolve) => {
          image.onload = resolve;
        });
        image.src = svg;
        await promise; // Wait for the image to load
        map.addImage(e.id, image);
      });

      map.addSource('compasspoint', {
        'type': 'geojson',
        'data': compassGeojson
      });

      map.addLayer({
        'id': 'compass-rose',
        'type': 'symbol',
        'source': 'compasspoint',
        'layout': {
          'icon-image': 'https://viking2917.github.io/bookmap/images/compass.svg',
          'icon-overlap': 'always',
          'text-overlap': 'always',
          'icon-size': 0.5,
          'icon-rotation-alignment': 'map',
        }
      });

      // When the cursor enters a feature in the point layer, prepare for dragging.
      map.on('mouseenter', 'compass-rose', () => {
        mapcanvas.style.cursor = 'move';
      });

      map.on('mouseleave', 'compass-rose', () => {
        mapcanvas.style.cursor = '';
      });

      map.on('mousedown', 'compass-rose', (e) => {
        // Prevent the default map drag behavior.
        e.preventDefault();

        mapcanvas.style.cursor = 'grab';

        map.on('mousemove', onMove);
        map.once('mouseup', onUp);
      });

      map.on('touchstart', 'compass-rose', (e) => {
        if (e.points.length !== 1) return;

        // Prevent the default map drag behavior.
        e.preventDefault();

        map.on('touchmove', onMove);
        map.once('touchend', onUp);
      });
    }

    function setupExportPlugin() {
      // Add export control
      // Use dynamic import to load the export control
      import('https://esm.sh/@watergis/maplibre-gl-export@3.8.0')
        .then(module => {
          const { MaplibreExportControl, Size, PageOrientation, Format, DPI } = module;

          map.addControl(
            new MaplibreExportControl({
              PageSize: Size.A4,
              PageOrientation: PageOrientation.Portrait,
              Format: Format.PNG,
              DPI: DPI[96],
              Crosshair: true,
              PrintableArea: true
            }),
            'bottom-left'
          );
        })
        .catch(err => console.error('Error loading export control:', err));
    }

    // Remove a GeoJSON source and its layers
    function removeGeoJSONSource(map, sourceId) {
      // Get all layers
      const layers = map.getStyle().layers;

      // Find and remove all layers that use this source
      layers.forEach(layer => {
        if (layer.source === sourceId) {
          map.removeLayer(layer.id);
        }
      });

      // Remove the source itself
      if (map.getSource(sourceId)) {
        map.removeSource(sourceId);
      }
    }

    function exportMapToHighRes(map) {
      // Get the map canvas
      const mapCanvas = map.getCanvas();

      // Create a new canvas for the combined image
      const exportCanvas = document.createElement('canvas');
      exportCanvas.width = mapCanvas.width;
      exportCanvas.height = mapCanvas.height;
      const ctx = exportCanvas.getContext('2d');

      // Draw the map
      ctx.drawImage(mapCanvas, 0, 0);

      // Export the combined canvas
      exportCanvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.download = `map-export-${Date.now()}.png`;
        link.href = url;
        link.click();
        URL.revokeObjectURL(url);

      }, 'image/png');

    }

    // ==============================================
    // DRAGGABLE COMPASS CODE
    // ==============================================
    function onMove(e) {
      const coords = e.lngLat;

      // Set a UI indicator for dragging.
      mapcanvas.style.cursor = 'grabbing';

      // Update the Point feature in `geojson` coordinates
      // and call setData to the source layer `point` on it.
      compassGeojson.features[0].geometry.coordinates = [coords.lng, coords.lat];
      map.getSource('compasspoint').setData(compassGeojson);
    }

    function onUp(e) {
      mapcanvas.style.cursor = '';
      // Unbind mouse/touch events
      map.off('mousemove', onMove);
      map.off('touchmove', onMove);
    }

  </script>
</body>

</html>