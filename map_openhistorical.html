<!DOCTYPE html>
<html lang="en">

<!-- caveat emptor: first versions of this created with Claude.AI. For fun only :)  -->

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Custom markers with MapTiler & OpenHistoricalMaps</title>
  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/@openhistoricalmap/maplibre-gl-dates/index.js"></script>
  <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }

    #map {
      width: 100%;
      height: 100vh;
    }

    .info-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      max-width: 300px;
    }

    .info-panel h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
    }

    .info-panel p {
      margin: 5px 0;
      font-size: 14px;
    }

    .maplibregl-popup-content {
      padding: 10px;
    }

    .maplibregl-popup-content h4 {
      margin: 0 0 5px 0;
    }

    .maplibregl-marker {
      z-index: 1000 !important;
    }

    #export-btn {
      position: absolute;
      top: 10px;
      right: 350px;
      z-index: 1000;
      padding: 10px 20px;
      background: white;
      border: 2px solid #333;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    #import-btn {
      position: absolute;
      top: 10px;
      right: 475px;
      z-index: 1000;
      padding: 10px 20px;
      background: white;
      border: 2px solid #333;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    #export-btn:hover, #import-btn:hover {
      background: #f0f0f0;
    }

    #export-btn:active, #import-btn:active {
      background: #e0e0e0;
    }

    #import-container {
      position: absolute;
      top: 10px;
      right: 500px;
      width: 30rem;
      z-index: 1000;
      background: white;
      border: 2px solid #333;
      border-radius: 4px;
      padding: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    #json-input {
      width: 300px;
      width: 95%;
      height: 100px;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      resize: vertical;
    }

    #import-btn-go {
      margin-top: 5px;
      padding: 8px 16px;
      background: #333;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      width: 100%;
    }

    #import-btn-go:hover {
      background: #555;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div class="info-panel">
    <h3>Instructions</h3>
    <p>Edit the <code>pointsOfInterest</code> array in the code to add your locations.</p>
    <!-- <p><strong>Format:</strong> [latitude, longitude, "Name", "Description"]</p> -->
    <!-- <p><em>Note: longitude comes first!</em></p> -->
  </div>
  <button id="export-btn">Export Map</button>
  <button id="import-btn">Set POI</button>
  <div id="import-container" style="display: none;">
    <textarea id="json-input" placeholder='Paste JSON here, e.g. {"points": [ [latitude, longitude, "Name", "Description"] ...]}'></textarea>
    <button id="import-btn-go">Set POI JSON</button>
  </div>

  <script>
    // ==============================================
    // EDIT YOUR POINTS OF INTEREST HERE
    // ==============================================
    // IMPORTANT: Format is [LONGITUDE, LATITUDE, name, description]
    // Longitude comes FIRST (this is different from Leaflet!)
    let pointsOfInterest = [
      [51.5074, -0.1278, "London", "London, England"],
      [48.8566, 2.3522, "Paris", "Paris, France"],
      [31.7683, 35.2137, "Jerusalem", "Jerusalem"],
      [32.9236, 35.0710, "Acre", "Acre, Israel"],
      [38.1938, 15.5540, "Messina", "Messina, Sicily"],
      [34.7071, 33.0226, "Limassol", "Limassol, Cyprus"],
      [33.5147, 36.2777, "Damascus", "Damascus, Syria"]
    ];

    pointsOfInterest = [
  [34.6731, 33.0449, "Limassol Castle"],
  [35.3086, 33.2811, "Saint Hilarion Castle"],
  [31.7683, 35.2137, "Jerusalem", "Jerusalem"],
  [34.7759, 35.9982, "Margat Castle"],
  [32.9236, 35.0710, "Acre"],
  [32.1066, 34.7781, "Arsuf & Jaffa"],
  //[31.6715, 34.5630, "Ascalon"],

];

    const rome = [12.49637, 41.90278];

    // Create GeoJSON from points
    let geojson = loadPOI();

    function loadPOI() {
      return {
        type: 'FeatureCollection',
        features: pointsOfInterest.map(poi => ({
          type: 'Feature',
          geometry: {
            type: 'Point',
            // lat/lon reversed in this map library...
            coordinates: [poi[1], poi[0]]
          },
          properties: {
            name: poi[2],
            description: poi[3]
          }
        }))
      };
    }

    document.getElementById('import-btn').addEventListener('click', () => {
      const panel = document.getElementById('import-container');
      panel.style.display = 'block';
    });

    function hideJsonPanel() {
      document.getElementById('import-container').style.display='none';
    }

    // Handle JSON import
    document.getElementById('import-btn-go').addEventListener('click', () => {
      const jsonText = document.getElementById('json-input').value;

      if (!jsonText.trim()) {
        alert('Please paste JSON first');
        return;
      }

      try {
        pointsOfInterest = JSON.parse(jsonText);
        loadPOI();
        display();
        hideJsonPanel();
        console.log('Points of Interest loaded:', pointsOfInterest);
        alert('POI JSON loaded successfully!');
      } catch (error) {
        console.error('Error parsing JSON:', error);
        alert('Error: Invalid JSON format');
      }
    });

    // ==============================================
    // MAP CONFIGURATION
    // ==============================================

    // Initialize the map with OpenHistoricalMap style
    //  style: 'https://unpkg.com/@openhistoricalmap/map-styles@latest/dist/woodblock/woodblock.json',
    const map = new maplibregl.Map({
      container: 'map',
      style: 'https://viking2917.github.io/bookmap/bookmap_openhistoricalmap.json',
      center: [rome[0], rome[1]], // Default center [lng, lat]
      zoom: 4,
      preserveDrawingBuffer: true
    });

    // Add navigation controls (zoom buttons)
    map.addControl(new maplibregl.NavigationControl({ showZoom: true }), 'top-left');

    // Add scale control
    map.addControl(new maplibregl.ScaleControl({
      maxWidth: 200,
      unit: 'metric'
    }), 'bottom-left');


    // ==============================================
    // OPTIONAL: DATE FILTERING
    // ==============================================
    // Uncomment the code below to filter the map by a specific year
    // This is useful for viewing historical data from a specific time period
    map.on('styledata', function () {
      // Set the year you want to display (example: 1900)
      const targetYear = 1187;
      const targetDate = `${targetYear}-01-01`;

      // Apply date filter if the function exists
      if (map.filterByDate) {
        console.log('data filtering map');
        map.filterByDate(targetDate);
      }
    });

    // ==============================================
    // ADD MARKERS AFTER MAP LOADS
    // ==============================================

    // ─────────────────────────────────────
    // 1️⃣ Add point source
    // ─────────────────────────────────────

    function display() {
      // remove if exists
      removeGeoJSONSource(map, 'poi-source');

      // Add source
      map.addSource('poi-source', {
        type: 'geojson',
        data: geojson
      });

      // ─────────────────────────────────────
      // 2️⃣ Outer engraved ring(s)
      // ─────────────────────────────────────
      map.addLayer({
        id: "marker-ring-2",
        type: "circle",
        source: "poi-source",
        paint: {
          "circle-radius": [
            "interpolate",
            ["linear"],
            ["zoom"],
            4, 6,
            10, 10
          ],
          "circle-color": "rgba(0,0,0,0)",
          "circle-stroke-width": 1,
          "circle-stroke-color": "rgba(255,255,255,0.5)",
          "circle-stroke-opacity": 0.9
        }
      });

      map.addLayer({
        id: "marker-ring",
        type: "circle",
        source: "poi-source",
        paint: {
          "circle-radius": [
            "interpolate",
            ["linear"],
            ["zoom"],
            4, 4,
            10, 8
          ],
          "circle-color": "rgba(0,0,0,0)",
          "circle-stroke-width": 2,
          "circle-stroke-color": "#696969",
          "circle-stroke-opacity": 0.9
        }
      });

      // ─────────────────────────────────────
      // 3️⃣ Inner ink dot
      // ─────────────────────────────────────
      map.addLayer({
        id: "marker-core",
        type: "circle",
        source: "poi-source",
        paint: {
          "circle-radius": [
            "interpolate",
            ["linear"],
            ["zoom"],
            4, 3,
            10, 6
          ],
          "circle-color": "#696969",
          "circle-opacity": 0.95
        }
      });

      // ─────────────────────────────────────
      // 4️⃣ City labels (engraved atlas style)
      // ─────────────────────────────────────
      map.addLayer({
        id: "marker-labels",
        type: "symbol",
        source: "poi-source",
        layout: {
          "text-field": ["get", "name"],
          "text-font": ["Noto Serif Bold"],
          "text-size": [
            "interpolate",
            ["linear"],
            ["zoom"],
            4, 16,
            10, 20
          ],
          "text-offset": [0.5, 0],
          "text-anchor": "left",
          "text-allow-overlap": true,
          "symbol-placement": "point"
        },
        paint: {
          "text-color": "#222",

          "text-halo-width": 1.5,

          // "text-halo-color": "#ff0000",          
          "text-halo-color": [
            "interpolate",
            ["linear"],
            ["zoom"],
            0, "rgba(240, 244, 216, 1)",
            10, "rgba(246,247,227, 1)"
          ],
        }
      });


      // Add click handler for popups
      map.on('click', 'poi-layer', (e) => {
        const coordinates = e.features[0].geometry.coordinates.slice();
        const { name, description } = e.features[0].properties;

        let popupHTML = `<h4>${name}</h4>`;
        if (description) popupHTML += `<p>${description}</p>`;

        new maplibregl.Popup()
          .setLngLat(coordinates)
          .setHTML(popupHTML)
          .addTo(map);
      });

      map.on('mouseenter', 'poi-layer', () => {
        map.getCanvas().style.cursor = 'pointer';
      });

      map.on('mouseleave', 'poi-layer', () => {
        map.getCanvas().style.cursor = '';
      });

      // Fit bounds
      const bounds = new maplibregl.LngLatBounds();
      pointsOfInterest.forEach(poi => bounds.extend([poi[1], poi[0]]));
      if (pointsOfInterest.length > 0) {
        map.fitBounds(bounds, { padding: 200, maxZoom: 15 });
      }
    }

    map.on('load', function () {
      display();
    });


    // Remove a GeoJSON source and its layers
function removeGeoJSONSource(map, sourceId) {
  // Get all layers
  const layers = map.getStyle().layers;
  
  // Find and remove all layers that use this source
  layers.forEach(layer => {
    if (layer.source === sourceId) {
      map.removeLayer(layer.id);
    }
  });
  
  // Remove the source itself
  if (map.getSource(sourceId)) {
    map.removeSource(sourceId);
  }
}



    async function exportMapToHighRes(map) {
      const exportBtn = document.getElementById('export-btn');
      exportBtn.style.display = 'none';

      // Hide all controls
      const controls = map.getContainer().querySelectorAll(
        '.maplibregl-ctrl-top-right, .maplibregl-ctrl-top-left, ' +
        '.maplibregl-ctrl-bottom-right, .maplibregl-ctrl-bottom-left'
      );
      controls.forEach(ctrl => {
        ctrl.style.display = 'none';
      });

      // Wait for controls to hide
      await new Promise(resolve => setTimeout(resolve, 100));

      // Get the canvas and export
      const canvas = map.getCanvas();
      canvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.download = `map-export-${Date.now()}.png`;
        link.href = url;
        link.click();
        URL.revokeObjectURL(url);

        // Restore controls and button
        controls.forEach(ctrl => {
          ctrl.style.display = '';
        });
        exportBtn.style.display = '';
      }, 'image/png');
    }

    // Usage
    document.getElementById('export-btn').addEventListener('click', () => {
      exportMapToHighRes(map);
    });

  </script>
</body>

</html>